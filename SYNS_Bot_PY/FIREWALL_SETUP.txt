==============================================================================
FIREWALL SETUP GUIDE - Protect VPS from Malicious Scanners
==============================================================================
Author: Claude
Date: 2025-11-05
Purpose: Block malicious scanners attacking port 80 (Bad request errors)

==============================================================================
PROBLEM: Log spam from malicious scanners
==============================================================================

Example logs:
143.110.171.108 - - [04/Nov/2025 19:32:24] code 400, message Bad request syntax
93.174.93.12 - - [04/Nov/2025 20:09:29] code 400, message Bad request version

These are NOT from your EA or Bot 2 - they are malicious bots scanning port 80!

==============================================================================
SOLUTION 1: Block specific IPs (Quick fix)
==============================================================================

# Block known scanner IPs
ufw deny from 143.110.171.108
ufw deny from 93.174.93.12
ufw reload

==============================================================================
SOLUTION 2: Whitelist only trusted IPs (RECOMMENDED)
==============================================================================

STEP 1: Find your IP addresses
-------------------------------
# Bot 2 VPS IP (where Bot 2 RECEIVER runs)
# EA VPS IP (where MT4/MT5 EA runs)
# Your laptop IP (if testing)

STEP 2: Reset firewall (CAREFUL - will disconnect!)
----------------------------------------------------
# Only do this if you can access VPS via console/KVM!

ufw --force reset
ufw default deny incoming
ufw default allow outgoing
ufw allow 22/tcp  # SSH (IMPORTANT - don't lock yourself out!)

STEP 3: Allow only trusted IPs to port 80
------------------------------------------
# Replace with your actual IPs:

ufw allow from YOUR_BOT2_IP to any port 80 proto tcp
ufw allow from YOUR_EA_VPS_IP to any port 80 proto tcp
ufw allow from YOUR_LAPTOP_IP to any port 80 proto tcp

# Example:
# ufw allow from 14.236.44.109 to any port 80 proto tcp
# ufw allow from 192.168.1.100 to any port 80 proto tcp

STEP 4: Allow Dashboard port 9070 (optional - for monitoring)
--------------------------------------------------------------
ufw allow 9070/tcp

STEP 5: Enable firewall
------------------------
ufw enable
ufw status verbose

==============================================================================
SOLUTION 3: Rate limiting (Advanced - prevent DDoS)
==============================================================================

# Limit connections to port 80 (max 10 per minute per IP)
ufw limit 80/tcp

# This will:
- Allow normal API calls (1 per second = 60/min is fine)
- Block scanners trying 100+ requests per minute

==============================================================================
SOLUTION 4: Fail2ban (Automatic IP banning)
==============================================================================

STEP 1: Install Fail2ban
-------------------------
apt update
apt install fail2ban -y

STEP 2: Configure Fail2ban for Flask
-------------------------------------
Create file: /etc/fail2ban/filter.d/flask-bad-request.conf

[Definition]
failregex = ^<HOST> .* code 400, message Bad request
ignoreregex =

STEP 3: Enable jail
-------------------
Create file: /etc/fail2ban/jail.d/flask.conf

[flask-bad-request]
enabled = true
port = 80
filter = flask-bad-request
logpath = /path/to/your/bot/log.txt
maxretry = 3
bantime = 3600
findtime = 300

STEP 4: Restart Fail2ban
-------------------------
systemctl restart fail2ban
fail2ban-client status

==============================================================================
VERIFICATION
==============================================================================

# Check firewall status
ufw status numbered

# Check blocked IPs
ufw status | grep DENY

# Test API from Bot 2 (should work)
curl http://147.189.173.121/api/symbols

# Test from unknown IP (should be blocked)
# Will timeout or connection refused

==============================================================================
ROLLBACK (If something goes wrong)
==============================================================================

# Disable firewall temporarily
ufw disable

# Remove all rules
ufw --force reset

# Re-enable basic access
ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 9070/tcp
ufw enable

==============================================================================
MONITORING
==============================================================================

# Watch firewall logs
tail -f /var/log/ufw.log

# Watch denied connections
grep BLOCK /var/log/ufw.log

# Count blocked IPs
grep BLOCK /var/log/ufw.log | awk '{print $11}' | sort | uniq -c | sort -rn

==============================================================================
IMPORTANT NOTES
==============================================================================

1. ‚ö†Ô∏è SSH Access: ALWAYS allow port 22 before enabling firewall!
   ufw allow 22/tcp

2. ‚ö†Ô∏è Testing: Test from Bot 2 and EA before enabling firewall

3. ‚úÖ Code fixes: Bot 1, Bot 2, Bot 3 code already updated to suppress logs

4. üîÑ Restart bots: After firewall setup, restart all bots to verify

5. üìä Dashboard: Still accessible on port 9070 (if allowed)

==============================================================================
EXPECTED RESULTS
==============================================================================

BEFORE (with quiet_mode=true + firewall):
-----------------------------------------
‚úÖ No "[API] Symbols list requested" spam
‚úÖ No "Request timed out" spam
‚úÖ No "code 400, Bad request" spam
‚úÖ Only real errors shown (500, crashes, etc.)

LOGS (normal operation):
------------------------
[2025-11-05 12:00:00] [INFO] Bot 1 started successfully
[2025-11-05 12:00:00] [INFO] API server on 0.0.0.0:80
[2025-11-05 12:00:00] [INFO] Dashboard on 0.0.0.0:9070
... (silent for hours) ...
[2025-11-05 18:00:00] [STATS] Saved stats to stats_logs/...

==============================================================================
EOF
==============================================================================
