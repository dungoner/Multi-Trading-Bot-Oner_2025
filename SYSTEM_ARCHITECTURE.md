# ğŸ—ï¸ KIáº¾N TRÃšC Há»† THá»NG TRADING BOT - MULTI-TIMEFRAME ONER V2

**Dá»± Ã¡n:** Multi-Trading-Bot-Oner V2
**Ná»n táº£ng:** WaveTrend (WT) Indicator - TÃ­n hiá»‡u gá»‘c
**PhiÃªn báº£n:** MT4 + MT5
**NgÃ y cáº­p nháº­t:** 2025-11-01

---

## ğŸ“– Má»¤C Lá»¤C

1. [Tá»•ng quan há»‡ thá»‘ng](#1-tá»•ng-quan-há»‡-thá»‘ng)
2. [Ná»n táº£ng WaveTrend (WT)](#2-ná»n-táº£ng-wavetrend-wt)
3. [SPY Bot - Bá»™ giÃ¡m sÃ¡t tÃ­n hiá»‡u](#3-spy-bot---bá»™-giÃ¡m-sÃ¡t-tÃ­n-hiá»‡u)
4. [EA Bot - Bá»™ thá»±c thi giao dá»‹ch](#4-ea-bot---bá»™-thá»±c-thi-giao-dá»‹ch)
5. [Giao tiáº¿p giá»¯a 2 Bots](#5-giao-tiáº¿p-giá»¯a-2-bots)
6. [SÆ¡ Ä‘á»“ luá»“ng tá»•ng thá»ƒ](#6-sÆ¡-Ä‘á»“-luá»“ng-tá»•ng-thá»ƒ)
7. [Chi tiáº¿t ká»¹ thuáº­t](#7-chi-tiáº¿t-ká»¹-thuáº­t)

---

## 1. Tá»”NG QUAN Há»† THá»NG

### 1.1. Kiáº¿n trÃºc 2 táº§ng

Há»‡ thá»‘ng Ä‘Æ°á»£c thiáº¿t káº¿ theo kiáº¿n trÃºc **2-tier** vá»›i phÃ¢n tÃ¡ch rÃµ rÃ ng:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Há»† THá»NG TRADING BOT                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   SPY BOT        â”‚  CSDL   â”‚    EA BOT        â”‚          â”‚
â”‚  â”‚  (Indicator)     â”‚ â”€â”€â”€â”€â”€â”€> â”‚ (Expert Advisor) â”‚          â”‚
â”‚  â”‚                  â”‚  File   â”‚                  â”‚          â”‚
â”‚  â”‚  â€¢ TÃ­nh tÃ­n hiá»‡u â”‚         â”‚  â€¢ Äá»c tÃ­n hiá»‡u  â”‚          â”‚
â”‚  â”‚  â€¢ PhÃ¢n tÃ­ch WT  â”‚         â”‚  â€¢ Thá»±c thi lá»‡nh â”‚          â”‚
â”‚  â”‚  â€¢ NEWS CASCADE  â”‚         â”‚  â€¢ Quáº£n lÃ½ rá»§i roâ”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â–²                              â”‚                     â”‚
â”‚         â”‚                              â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  WT Indicatorâ”‚            â”‚  MT4/MT5 Brokerâ”‚             â”‚
â”‚  â”‚  (7 TF Data) â”‚            â”‚  (Live Trading)â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2. Vai trÃ² tá»«ng thÃ nh pháº§n

| ThÃ nh pháº§n | Loáº¡i | Vai trÃ² | Vá»‹ trÃ­ |
|------------|------|---------|--------|
| **WaveTrend (WT)** | Indicator gá»‘c | Táº¡o tÃ­n hiá»‡u BUY/SELL nguyÃªn báº£n | TÃ­ch há»£p trong SPY |
| **SPY Bot** | Indicator MT4 | GiÃ¡m sÃ¡t 7 TF, tÃ­nh NEWS CASCADE, ghi file | Chart báº¥t ká»³ (1 symbol) |
| **CSDL File** | JSON Data | Trung gian truyá»n dá»¯ liá»‡u | `DataAutoOner\[SYMBOL].json` |
| **EA Bot** | Expert Advisor | Äá»c tÃ­n hiá»‡u, thá»±c thi lá»‡nh, quáº£n lÃ½ risk | Chart giao dá»‹ch |

### 1.3. Luá»“ng dá»¯ liá»‡u tá»•ng quÃ¡t

```
WaveTrend (7 TF)
    â†“
SPY Bot (tÃ­nh toÃ¡n + phÃ¢n tÃ­ch)
    â†“
CSDL File (JSON)
    â†“
EA Bot (Ä‘á»c file)
    â†“
Trading Execution (MT4/MT5)
```

---

## 2. Ná»€N Táº¢NG WAVETREND (WT)

### 2.1. WaveTrend lÃ  gÃ¬?

**WaveTrend** lÃ  oscillator indicator phá»• biáº¿n trong trading, tÆ°Æ¡ng tá»± RSI nhÆ°ng mÆ°á»£t hÆ¡n vÃ  nháº¡y vá»›i momentum.

**Äáº·c Ä‘iá»ƒm:**
- Range: -100 Ä‘áº¿n +100
- Cross zero line: TÃ­n hiá»‡u mua/bÃ¡n
- Overbought/Oversold zones: Â±60 thÆ°á»ng Ä‘Æ°á»£c dÃ¹ng
- Smooth curves: Giáº£m noise so vá»›i RSI

### 2.2. TÃ­n hiá»‡u WT trong há»‡ thá»‘ng

SPY Bot sá»­ dá»¥ng WT Ä‘á»ƒ táº¡o 3 loáº¡i tÃ­n hiá»‡u:

```
WT > 0  AND  Crossing Up    â†’  SIGNAL = +1 (BUY)
WT < 0  AND  Crossing Down  â†’  SIGNAL = -1 (SELL)
No clear signal            â†’  SIGNAL = 0 (NEUTRAL)
```

### 2.3. Táº¡i sao chá»n WT?

1. **Smooth momentum**: Ãt false signals hÆ¡n RSI
2. **Multi-timeframe consistency**: WT hoáº¡t Ä‘á»™ng tá»‘t trÃªn cáº£ 7 TF
3. **Clear reversal points**: Cross-over/cross-under dá»… xÃ¡c Ä‘á»‹nh
4. **Proven track record**: Nhiá»u trader sá»­ dá»¥ng thÃ nh cÃ´ng

### 2.4. WT trong 7 Timeframes

SPY Bot tÃ­nh WT Ä‘á»™c láº­p cho má»—i TF:

| Timeframe | WT Period | Smoothing | Sensitivity |
|-----------|-----------|-----------|-------------|
| **M1** | Fast | Low | Highest (scalping) |
| **M5** | Fast | Medium | High |
| **M15** | Medium | Medium | Medium-High |
| **M30** | Medium | Medium | Medium |
| **H1** | Slow | High | Medium-Low |
| **H4** | Slow | High | Low |
| **D1** | Very Slow | Very High | Lowest (swing) |

**Káº¿t luáº­n:** WT lÃ  trÃ¡i tim cá»§a há»‡ thá»‘ng, táº¡o ná»n táº£ng tÃ­n hiá»‡u cho táº¥t cáº£ strategies.

---

## 3. SPY BOT - Bá»˜ GIÃM SÃT TÃN HIá»†U

### 3.1. Má»¥c Ä‘Ã­ch

**SPY Bot** = Signal Processing Yielder (Bá»™ táº¡o tÃ­n hiá»‡u xá»­ lÃ½)

**Nhiá»‡m vá»¥ chÃ­nh:**
1. âœ… TÃ­nh toÃ¡n WaveTrend cho 7 timeframes
2. âœ… PhÃ¡t hiá»‡n signal changes (BUY â†” SELL)
3. âœ… PhÃ¢n tÃ­ch NEWS CASCADE (Ä‘á»™ máº¡nh tÃ­n hiá»‡u)
4. âœ… TÃ­nh PriceDiff vÃ  TimeDiff giá»¯a cÃ¡c TF
5. âœ… Ghi dá»¯ liá»‡u vÃ o file CSDL theo format chuáº©n
6. âœ… Maintain history (7 signals per TF)

### 3.2. Cáº¥u trÃºc dá»¯ liá»‡u - CSDL 10 Columns

SPY Bot táº¡o file JSON vá»›i **10 cá»™t dá»¯ liá»‡u** cho má»—i timeframe:

| Cá»™t | TÃªn | Ã nghÄ©a | GiÃ¡ trá»‹ |
|-----|-----|---------|---------|
| 1 | Timeframe | Khung thá»i gian | M1/M5/M15/M30/H1/H4/D1 |
| 2 | Index | Chá»‰ sá»‘ TF | 0-6 |
| 3 | **Signal** | TÃ­n hiá»‡u WT | +1 (BUY), -1 (SELL), 0 (NEUTRAL) |
| 4 | **Price** | GiÃ¡ entry | Ask/Bid price |
| 5 | **Cross** | Cross reference | Timestamp cá»§a TF trÆ°á»›c |
| 6 | **Timestamp** | Thá»i gian | Unix timestamp |
| 7 | **PriceDiff** | ChÃªnh lá»‡ch giÃ¡ | USD difference tá»« signal trÆ°á»›c |
| 8 | **TimeDiff** | ChÃªnh lá»‡ch thá»i gian | Minutes tá»« signal trÆ°á»›c |
| 9 | **NEWS** | NEWS CASCADE | Â±11 Ä‘áº¿n Â±16 (level 1-6) hoáº·c 0 |
| 10 | **MaxLoss** | Max loss tracking | Negative value (USD) |

**VÃ­ dá»¥ dá»¯ liá»‡u CSDL:**
```json
{
  "M1": {
    "signal": 1,
    "price": 2045.50,
    "cross": 1730451234,
    "timestamp": 1730451240,
    "pricediff": 2.5,
    "timediff": 3,
    "news": 14,
    "maxloss": -15.50
  },
  "M5": {
    "signal": 1,
    "price": 2045.30,
    ...
  }
}
```

### 3.3. OnTimer() Flow - Chá»©c nÄƒng chÃ­nh

**SPY Bot cháº¡y má»—i 1 giÃ¢y** vá»›i OnTimer():

```
OnTimer() - Called every 1 second
â”‚
â”œâ”€ CHá»¨C NÄ‚NG CHÃNH (Main Function)
â”‚  â”‚
â”‚  â”œâ”€ EVEN/ODD Mode Check
â”‚  â”‚  â”œâ”€ If ProcessSignalOnOddSecond = true  â†’ Run on ODD seconds only
â”‚  â”‚  â””â”€ If ProcessSignalOnOddSecond = false â†’ Run every second
â”‚  â”‚
â”‚  â””â”€ ProcessAllSignals()  â† CORE FUNCTION
â”‚     â”‚
â”‚     â”œâ”€ Loop 7 TF (M1 â†’ D1)
â”‚     â”‚  â”‚
â”‚     â”‚  â”œâ”€ Switch to TF chart
â”‚     â”‚  â”‚
â”‚     â”‚  â”œâ”€ Calculate WaveTrend
â”‚     â”‚  â”‚  â”œâ”€ Read WT indicator values
â”‚     â”‚  â”‚  â”œâ”€ Detect cross-over/cross-under
â”‚     â”‚  â”‚  â””â”€ Generate Signal: +1, -1, or 0
â”‚     â”‚  â”‚
â”‚     â”‚  â”œâ”€ Calculate PriceDiff (USD)
â”‚     â”‚  â”‚  â””â”€ Current Price - Last Signal Price
â”‚     â”‚  â”‚
â”‚     â”‚  â”œâ”€ Calculate TimeDiff (minutes)
â”‚     â”‚  â”‚  â””â”€ Current Time - Last Signal Time
â”‚     â”‚  â”‚
â”‚     â”‚  â”œâ”€ Calculate NEWS CASCADE
â”‚     â”‚  â”‚  â”œâ”€ Analyze 6 TFs alignment
â”‚     â”‚  â”‚  â”œâ”€ Check LiveDiff threshold
â”‚     â”‚  â”‚  â”œâ”€ Check TimeDiff threshold
â”‚     â”‚  â”‚  â””â”€ Return Â±11 to Â±16 (level 1-6)
â”‚     â”‚  â”‚
â”‚     â”‚  â”œâ”€ Update MaxLoss tracking
â”‚     â”‚  â”‚
â”‚     â”‚  â””â”€ Save to CSDL array
â”‚     â”‚
â”‚     â””â”€ Write CSDL File
â”‚        â”œâ”€ Format: JSON
â”‚        â””â”€ Path: DataAutoOner\[SYMBOL].json
â”‚
â””â”€ CHá»¨C NÄ‚NG PHá»¤ (Auxiliary - Even seconds only)
   â”‚
   â”œâ”€ UpdateLiveNEWS()
   â”‚  â””â”€ Update NEWS values in real-time
   â”‚
   â”œâ”€ RunStartupReset()
   â”‚  â””â”€ Auto-reset 1 minute after MT4 starts
   â”‚
   â”œâ”€ RunMidnightAndHealthCheck()
   â”‚  â”œâ”€ Midnight reset at 0h daily
   â”‚  â””â”€ Health check at 8h & 16h
   â”‚
   â””â”€ RunDashboardUpdate()
      â””â”€ Update visual dashboard on chart
```

### 3.4. NEWS CASCADE Strategy

**NEWS CASCADE** lÃ  phÃ¢n tÃ­ch Ä‘á»™ máº¡nh cá»§a tÃ­n hiá»‡u dá»±a trÃªn:

**CÃ´ng thá»©c:**
```
NEWS Level = Count aligned TFs Ã— Price momentum Ã— Time factor

Level 1 (Â±11): 2-3 TFs aligned, weak momentum
Level 2 (Â±12): 3-4 TFs aligned, medium momentum
Level 3 (Â±13): 4-5 TFs aligned, good momentum
Level 4 (Â±14): 5-6 TFs aligned, strong momentum
Level 5 (Â±15): 6-7 TFs aligned, very strong momentum
Level 6 (Â±16): All 7 TFs aligned, extreme momentum
```

**á»¨ng dá»¥ng:**
- EA Bot sá»­ dá»¥ng NEWS Ä‘á»ƒ filter signals (S3_NEWS strategy)
- Bonus orders má»Ÿ khi NEWS >= threshold
- Risk management dá»±a trÃªn NEWS level

### 3.5. File I/O Operations

**Write Operation:**
```cpp
void WriteToFile() {
    // Open file in DataAutoOner\ folder
    string filename = DataAutoOner\XAUUSD.json;

    // Format JSON with 10 columns for 7 TFs
    string json = "{\n";
    for(int tf = 0; tf < 7; tf++) {
        json += "  \"" + TF_NAMES[tf] + "\": {\n";
        json += "    \"signal\": " + signals[tf] + ",\n";
        json += "    \"price\": " + prices[tf] + ",\n";
        // ... 8 more columns
        json += "  },\n";
    }
    json += "}";

    // Write atomically (avoid corruption)
    FileWrite(handle, json);
    FileClose(handle);
}
```

**Retry Logic:**
- Retry up to 3 times if write fails
- Avoid file lock conflicts with EA Bot

### 3.6. Health Monitoring

SPY Bot tá»± Ä‘á»™ng kiá»ƒm tra sá»©c khá»e:

1. **Startup Reset** (1 minute after MT4 starts)
   - Refresh all 7 TF charts
   - Clear cache
   - Reinitialize data structures

2. **Midnight Reset** (0h daily)
   - Reset counters
   - Archive old data
   - Smart TF refresh

3. **Health Check** (8h & 16h)
   - Check if CSDL file is updating
   - If stuck â†’ Auto-reset all TF charts
   - Alert user if bot frozen

---

## 4. EA BOT - Bá»˜ THá»°C THI GIAO Dá»ŠCH

### 4.1. Má»¥c Ä‘Ã­ch

**EA Bot** = Expert Advisor Bot (Bá»™ tÆ° váº¥n chuyÃªn gia)

**Nhiá»‡m vá»¥ chÃ­nh:**
1. âœ… Äá»c file CSDL tá»« SPY Bot
2. âœ… Map data vÃ o 7 timeframes
3. âœ… Thá»±c thi 3 strategies (S1, S2, S3) + BONUS
4. âœ… Quáº£n lÃ½ 21 orders (7 TF Ã— 3 strategies)
5. âœ… Risk management (stoploss, takeprofit, emergency)
6. âœ… Dashboard monitoring

### 4.2. Kiáº¿n trÃºc Strategies

EA Bot quáº£n lÃ½ **4 loáº¡i strategy** trÃªn **7 timeframes** = **28 strategy instances**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   EA BOT STRATEGIES                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   TF    â”‚  S1_HOME â”‚ S2_TREND â”‚ S3_NEWS  â”‚ S3_BONUS â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ M1 (0)  â”‚  Magic 1 â”‚ Magic 2  â”‚ Magic 3  â”‚ Magic 3  â”‚   â”‚
â”‚  â”‚ M5 (1)  â”‚  Magic 4 â”‚ Magic 5  â”‚ Magic 6  â”‚ Magic 6  â”‚   â”‚
â”‚  â”‚ M15 (2) â”‚  Magic 7 â”‚ Magic 8  â”‚ Magic 9  â”‚ Magic 9  â”‚   â”‚
â”‚  â”‚ M30 (3) â”‚  Magic 10â”‚ Magic 11 â”‚ Magic 12 â”‚ Magic 12 â”‚   â”‚
â”‚  â”‚ H1 (4)  â”‚  Magic 13â”‚ Magic 14 â”‚ Magic 15 â”‚ Magic 15 â”‚   â”‚
â”‚  â”‚ H4 (5)  â”‚  Magic 16â”‚ Magic 17 â”‚ Magic 18 â”‚ Magic 18 â”‚   â”‚
â”‚  â”‚ D1 (6)  â”‚  Magic 19â”‚ Magic 20 â”‚ Magic 21 â”‚ Magic 21 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  Total: 21 unique magic numbers (7 TF Ã— 3 strategies)      â”‚
â”‚  BONUS uses same magic as S3_NEWS for each TF              â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3. Chi tiáº¿t tá»«ng Strategy

#### **Strategy 1: S1_HOME (Binary Signal)**

**Logic:**
```
Má»Ÿ lá»‡nh KHI:
- Signal thay Ä‘á»•i tá»« 0 â†’ +1 hoáº·c 0 â†’ -1
- HOáº¶C Signal Ä‘áº£o chiá»u: +1 â†’ -1 hoáº·c -1 â†’ +1

Option: NEWS Filter
- Náº¿u báº­t: Chá»‰ má»Ÿ khi NEWS != 0
- Náº¿u táº¯t: Má»Ÿ má»i signal change
```

**Use case:** Scalping, theo sÃ¡t má»i thay Ä‘á»•i tÃ­n hiá»‡u

#### **Strategy 2: S2_TREND (Trend Following)**

**Logic:**
```
Má»Ÿ lá»‡nh KHI:
- D1 signal há»— trá»£ (cÃ¹ng hÆ°á»›ng HOáº¶C neutral)
- Signal thay Ä‘á»•i
- Timestamp má»›i hÆ¡n timestamp cÅ©

ÄÃ³ng lá»‡nh KHI:
- Signal Ä‘áº£o chiá»u
```

**Use case:** Swing trading, theo xu hÆ°á»›ng lá»›n

#### **Strategy 3: S3_NEWS (News Alignment)**

**Logic:**
```
Má»Ÿ lá»‡nh KHI:
- Signal cÃ¹ng dáº¥u vá»›i NEWS
- NEWS != 0
- Signal thay Ä‘á»•i

ÄÃ³ng lá»‡nh KHI:
- Signal thay Ä‘á»•i (khÃ´ng cáº§n check NEWS)
```

**Use case:** High-momentum trading, táº­n dá»¥ng tin tá»©c

#### **Strategy 4: S3_BONUS (Extra News Orders)**

**Logic:**
```
Má»Ÿ lá»‡nh KHI:
- M1 signal thay Ä‘á»•i
- NEWS >= MinNewsLevelBonus (e.g., 13)
- Má»Ÿ NHIá»€U lá»‡nh (BonusOrderCount)
- Lot size = S3 lot Ã— BonusLotMultiplier

ÄÃ³ng lá»‡nh KHI:
- M1 signal thay Ä‘á»•i láº§n ná»¯a
- ÄÃ³ng Táº¤T Cáº¢ 7 TF bonus cÃ¹ng lÃºc
```

**Use case:** Aggressive momentum capture

### 4.4. OnTimer() Flow - Chá»©c nÄƒng chÃ­nh

**EA Bot cháº¡y má»—i 1 giÃ¢y** vá»›i OnTimer():

```
OnTimer() - Called every 1 second
â”‚
â”œâ”€ Prevent duplicate execution
â”‚
â”œâ”€ GROUP 1: EVEN SECONDS (0,2,4,6,8...) - TRADING CORE
â”‚  â”‚
â”‚  â”œâ”€ STEP 1: ReadCSDLFile()
â”‚  â”‚  â”œâ”€ Open DataAutoOner\[SYMBOL].json
â”‚  â”‚  â”œâ”€ Parse JSON (10 columns Ã— 7 TF)
â”‚  â”‚  â””â”€ Store in g_ea.csdl_rows[7]
â”‚  â”‚
â”‚  â”œâ”€ STEP 2: MapCSDLToEAVariables()
â”‚  â”‚  â””â”€ Copy CSDL data to EA working variables
â”‚  â”‚
â”‚  â””â”€ STEP 3: Strategy Loop (7 TF)
â”‚     â”‚
â”‚     FOR tf = 0 to 6:
â”‚     â”‚
â”‚     IF HasValidS2BaseCondition(tf):  â† Signal changed?
â”‚     â”‚
â”‚     â”œâ”€ STEP 3.1: Close ALL Bonus Orders (M1 trigger)
â”‚     â”‚  IF (tf == 0 AND EnableBonusNews):
â”‚     â”‚     CloseAllBonusOrders()  â† Closes ALL 7 TF bonus
â”‚     â”‚
â”‚     â”œâ”€ STEP 3.2: Close old orders for THIS TF
â”‚     â”‚  CloseAllStrategiesByMagicForTF(tf)
â”‚     â”‚  â””â”€ Close magic[tf][0], magic[tf][1], magic[tf][2]
â”‚     â”‚
â”‚     â”œâ”€ STEP 3.3: Open new orders (if TF enabled)
â”‚     â”‚  IF IsTFEnabled(tf):
â”‚     â”‚     IF S1_HOME:  ProcessS1Strategy(tf)
â”‚     â”‚     IF S2_TREND: ProcessS2Strategy(tf)
â”‚     â”‚     IF S3_NEWS:  ProcessS3Strategy(tf)
â”‚     â”‚
â”‚     â”œâ”€ STEP 3.4: Process Bonus News (INSIDE loop, BEFORE old=new)
â”‚     â”‚  IF EnableBonusNews:
â”‚     â”‚     ProcessBonusNews()
â”‚     â”‚        â””â”€ Scan ALL 7 TF for NEWS >= threshold
â”‚     â”‚           Open BonusOrderCount orders with bonus lot
â”‚     â”‚
â”‚     â””â”€ STEP 3.5: Update baseline
â”‚        g_ea.signal_old[tf] = g_ea.csdl_rows[tf].signal
â”‚        g_ea.timestamp_old[tf] = g_ea.csdl_rows[tf].timestamp
â”‚
â””â”€ GROUP 2: ODD SECONDS (1,3,5,7,9...) - AUXILIARY
   â”‚
   â”œâ”€ CheckStoplossAndTakeProfit()
   â”‚  â”œâ”€ Layer 1 Stoploss: Per-order max loss
   â”‚  â”œâ”€ Layer 2 Stoploss: Per-TF cumulative loss
   â”‚  â””â”€ Take Profit: Per-order profit target
   â”‚
   â”œâ”€ UpdateDashboard()
   â”‚  â””â”€ Display 21 orders status on chart
   â”‚
   â”œâ”€ CheckAllEmergencyConditions()
   â”‚  â”œâ”€ Equity drop emergency
   â”‚  â”œâ”€ Drawdown emergency
   â”‚  â””â”€ Close all if threshold exceeded
   â”‚
   â”œâ”€ CheckWeekendReset()
   â”‚  â””â”€ Reset flags on Monday
   â”‚
   â””â”€ CheckSPYBotHealth()
      â””â”€ Alert if SPY bot not updating
```

### 4.5. Critical Logic - HasValidS2BaseCondition()

**HÃ m quan trá»ng nháº¥t** quyáº¿t Ä‘á»‹nh cÃ³ xá»­ lÃ½ TF hay khÃ´ng:

```cpp
bool HasValidS2BaseCondition(int tf) {
    int signal_old = g_ea.signal_old[tf];
    int signal_new = g_ea.csdl_rows[tf].signal;
    datetime timestamp_old = g_ea.timestamp_old[tf];
    datetime timestamp_new = g_ea.csdl_rows[tf].timestamp;

    // Chá»‰ xá»­ lÃ½ KHI:
    // 1. Signal thay Ä‘á»•i (old != new)
    // 2. Signal má»›i há»£p lá»‡ (new != 0)
    // 3. Timestamp má»›i hÆ¡n (avoid duplicate)

    return (signal_old != signal_new &&
            signal_new != 0 &&
            timestamp_old < timestamp_new);
}
```

**Táº¡i sao quan trá»ng?**
- TrÃ¡nh spam orders khi signal khÃ´ng Ä‘á»•i
- Äáº£m báº£o timestamp luÃ´n tÄƒng (khÃ´ng xá»­ lÃ½ signal cÅ©)
- Filter neutral signals (0)

### 4.6. Risk Management - 3 Layers

#### **Layer 1: Per-Order Stoploss**
```
Check Má»–I order:
- If profit < -MaxLossPerOrder
  â†’ Close immediately
```

#### **Layer 2: Per-TF Cumulative Stoploss**
```
Check Tá»”NG profit cá»§a 3 strategies trong TF:
- Total = S1 profit + S2 profit + S3 profit
- If Total < -(MaxLossPerOrder Ã— 3)
  â†’ Close ALL 3 strategies cá»§a TF Ä‘Ã³
```

#### **Layer 3: Emergency Conditions**
```
Check toÃ n bá»™ account:
- If Equity < Balance Ã— (1 - EmergencyDrawdownPercent)
  â†’ Close ALL 21 orders
  â†’ Stop trading
```

### 4.7. Magic Number System

**CÃ´ng thá»©c tÃ­nh magic number:**

```
Magic = BaseMagic + (TF_index Ã— 3) + Strategy_index

VÃ­ dá»¥:
- M1 (tf=0) + S1 (s=0) â†’ Magic = 100 + (0Ã—3) + 0 = 100
- M1 (tf=0) + S2 (s=1) â†’ Magic = 100 + (0Ã—3) + 1 = 101
- M1 (tf=0) + S3 (s=2) â†’ Magic = 100 + (0Ã—3) + 2 = 102
- M5 (tf=1) + S1 (s=0) â†’ Magic = 100 + (1Ã—3) + 0 = 103
- D1 (tf=6) + S3 (s=2) â†’ Magic = 100 + (6Ã—3) + 2 = 120
```

**21 magic numbers:**
```
TF  â”‚ S1   â”‚ S2   â”‚ S3
â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€
M1  â”‚ 100  â”‚ 101  â”‚ 102
M5  â”‚ 103  â”‚ 104  â”‚ 105
M15 â”‚ 106  â”‚ 107  â”‚ 108
M30 â”‚ 109  â”‚ 110  â”‚ 111
H1  â”‚ 112  â”‚ 113  â”‚ 114
H4  â”‚ 115  â”‚ 116  â”‚ 117
D1  â”‚ 118  â”‚ 119  â”‚ 120
```

**Lá»£i Ã­ch:**
- Unique identifier cho má»—i order
- Dá»… debug: NhÃ¬n magic biáº¿t ngay TF + Strategy
- Close by magic: ÄÃ³ng chÃ­nh xÃ¡c strategy cáº§n thiáº¿t

---

## 5. GIAO TIáº¾P GIá»®A 2 BOTS

### 5.1. File-Based Communication

**PhÆ°Æ¡ng thá»©c:** SPY ghi â†’ EA Ä‘á»c (file JSON)

**LÃ½ do chá»n file thay vÃ¬ alternatives:**

| PhÆ°Æ¡ng Ã¡n | Æ¯u Ä‘iá»ƒm | NhÆ°á»£c Ä‘iá»ƒm | Lá»±a chá»n |
|-----------|---------|------------|----------|
| **File JSON** | Simple, reliable, debuggable | File I/O overhead | âœ… CHá»ŒN |
| Global Variables | Fast | Limited size, MT4 only | âŒ |
| Named Pipes | Very fast | Complex, OS-dependent | âŒ |
| Memory Mapping | Fastest | Very complex, risky | âŒ |

### 5.2. File Format - CSDL JSON Structure

**File:** `DataAutoOner\XAUUSD.json`

```json
{
  "M1": {
    "signal": 1,
    "price": 2045.50,
    "cross": 1730451234,
    "timestamp": 1730451240,
    "pricediff": 2.5,
    "timediff": 3,
    "news": 14,
    "maxloss": -15.50
  },
  "M5": {
    "signal": -1,
    "price": 2045.30,
    "cross": 1730451180,
    "timestamp": 1730451200,
    "pricediff": -3.2,
    "timediff": 8,
    "news": -12,
    "maxloss": -8.20
  },
  ... (5 more TFs)
}
```

### 5.3. Timing Coordination

**TrÃ¡nh file lock conflict:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  TIMELINE (1 Second)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  Second:  0    1    2    3    4    5    6    7    8... â”‚
â”‚           â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚
â”‚  SPY:     â”‚    W    â”‚    W    â”‚    W    â”‚    W    â”‚    â”‚  W = Write
â”‚           â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚
â”‚  EA:      R    â”‚    R    â”‚    R    â”‚    R    â”‚    R... â”‚  R = Read
â”‚           â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SPY writes on ODD seconds (1, 3, 5, 7...)
EA reads on EVEN seconds (0, 2, 4, 6...)
â†’ NO CONFLICT!
```

**Cáº¥u hÃ¬nh:**
- SPY: `ProcessSignalOnOddSecond = true`
- EA: `UseEvenOddMode = true`

### 5.4. Data Latency

**Äá»™ trá»… tá»‘i Ä‘a:** 1 giÃ¢y

```
Time 0:00:01 - SPY detects signal change â†’ Write CSDL
Time 0:00:02 - EA reads CSDL â†’ Execute trade
Total latency: 1 second
```

**Cháº¥p nháº­n Ä‘Æ°á»£c vÃ¬:**
- Trading timeframe nhá» nháº¥t lÃ  M1 (60 seconds)
- 1 second delay khÃ´ng áº£nh hÆ°á»Ÿng entry price Ä‘Ã¡ng ká»ƒ
- Reliability > Speed trong trading

### 5.5. Error Handling

**SPY Bot:**
```cpp
int retry = 0;
while(retry < 3) {
    if(WriteToFile(data)) {
        break;  // Success
    }
    Sleep(100);
    retry++;
}
```

**EA Bot:**
```cpp
int retry = 0;
while(retry < 3) {
    if(ReadFromFile(data)) {
        if(ValidateData(data)) {
            break;  // Success
        }
    }
    Sleep(100);
    retry++;
}
// If all retries fail â†’ Use old data, don't trade
```

---

## 6. SÆ  Äá»’ LUá»’NG Tá»”NG THá»‚

### 6.1. Flowchart - ToÃ n há»‡ thá»‘ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SYSTEM STARTUP                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                           â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   SPY Bot Init   â”‚        â”‚    EA Bot Init   â”‚
          â”‚                  â”‚        â”‚                  â”‚
          â”‚ â€¢ Load settings  â”‚        â”‚ â€¢ Load settings  â”‚
          â”‚ â€¢ Init data      â”‚        â”‚ â€¢ Init magic #s  â”‚
          â”‚ â€¢ Start timer    â”‚        â”‚ â€¢ Start timer    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                           â”‚
                   â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MAIN LOOP (Every 1 Second)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                           â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚    SPY OnTimer()     â”‚    â”‚     EA OnTimer()     â”‚
       â”‚   (ODD seconds)      â”‚    â”‚   (EVEN seconds)     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                           â”‚
                   â–¼                           â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
       â”‚ Calculate WT (7 TF)   â”‚               â”‚
       â”‚                       â”‚               â”‚
       â”‚ FOR each TF:          â”‚               â”‚
       â”‚  â€¢ Read WT values     â”‚               â”‚
       â”‚  â€¢ Detect cross       â”‚               â”‚
       â”‚  â€¢ Gen signal Â±1/0    â”‚               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
                   â–¼                           â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
       â”‚ Analyze NEWS CASCADE  â”‚               â”‚
       â”‚                       â”‚               â”‚
       â”‚ â€¢ Check 7 TF align    â”‚               â”‚
       â”‚ â€¢ Calc price momentum â”‚               â”‚
       â”‚ â€¢ Calc time factor    â”‚               â”‚
       â”‚ â€¢ Return Â±11 to Â±16   â”‚               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
                   â–¼                           â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
       â”‚ Update CSDL Data      â”‚               â”‚
       â”‚                       â”‚               â”‚
       â”‚ â€¢ 7 TF Ã— 10 columns   â”‚               â”‚
       â”‚ â€¢ Update history      â”‚               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
                   â–¼                           â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
       â”‚ Write JSON File       â”‚               â”‚
       â”‚                       â”‚               â”‚
       â”‚ â€¢ Format JSON         â”‚               â”‚
       â”‚ â€¢ Atomic write        â”‚               â”‚
       â”‚ â€¢ Retry on failure    â”‚               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
                   â”‚                           â”‚
                   â”‚   CSDL File               â”‚
                   â”‚   (JSON)                  â”‚
                   â”‚                           â”‚
                   â”‚                           â–¼
                   â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚               â”‚ Read CSDL File        â”‚
                   â”‚               â”‚                       â”‚
                   â”‚               â”‚ â€¢ Parse JSON          â”‚
                   â”‚               â”‚ â€¢ Validate data       â”‚
                   â”‚               â”‚ â€¢ Retry on failure    â”‚
                   â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                           â–¼
                   â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚               â”‚ Map to EA Variables   â”‚
                   â”‚               â”‚                       â”‚
                   â”‚               â”‚ â€¢ 7 TF Ã— 10 columns   â”‚
                   â”‚               â”‚ â€¢ Store in g_ea       â”‚
                   â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                           â–¼
                   â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚               â”‚ FOR each TF (0-6):    â”‚
                   â”‚               â”‚                       â”‚
                   â”‚               â”‚ IF signal changed:    â”‚
                   â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                           â–¼
                   â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚               â”‚ Close Old Orders      â”‚
                   â”‚               â”‚                       â”‚
                   â”‚               â”‚ â€¢ Close S1/S2/S3      â”‚
                   â”‚               â”‚ â€¢ Reset flags         â”‚
                   â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                           â–¼
                   â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚               â”‚ Open New Orders       â”‚
                   â”‚               â”‚                       â”‚
                   â”‚               â”‚ IF S1: ProcessS1()    â”‚
                   â”‚               â”‚ IF S2: ProcessS2()    â”‚
                   â”‚               â”‚ IF S3: ProcessS3()    â”‚
                   â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                           â–¼
                   â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚               â”‚ Process BONUS         â”‚
                   â”‚               â”‚                       â”‚
                   â”‚               â”‚ IF NEWS >= threshold: â”‚
                   â”‚               â”‚  â€¢ Open bonus orders  â”‚
                   â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                           â–¼
                   â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚               â”‚ Update baseline       â”‚
                   â”‚               â”‚                       â”‚
                   â”‚               â”‚ â€¢ signal_old = new    â”‚
                   â”‚               â”‚ â€¢ timestamp_old = new â”‚
                   â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                           â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚                   â”‚
                                               â–¼                   â–¼
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚ Risk Management   â”‚ â”‚ Dashboard      â”‚
                                   â”‚                   â”‚ â”‚                â”‚
                                   â”‚ â€¢ Stoploss check  â”‚ â”‚ â€¢ Show 21 pos  â”‚
                                   â”‚ â€¢ Takeprofit      â”‚ â”‚ â€¢ Show P&L     â”‚
                                   â”‚ â€¢ Emergency       â”‚ â”‚ â€¢ Alert status â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚
                                               â–¼
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚   BROKER (MT4/MT5)    â”‚
                                   â”‚                       â”‚
                                   â”‚   Live Trading        â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2. Sequence Diagram - Signal Processing

```
Time  SPY Bot           CSDL File         EA Bot            Broker
â”‚
â”‚ 1s   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¤
â”‚      â”‚ Calculate WT
â”‚      â”‚ Detect BUY signal
â”‚      â”‚
â”‚      â”‚ Write JSON â”€â”€â”€â”€>â”‚
â”‚      â”‚                 â”‚
â”‚ 2s   â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¤                 â”‚
â”‚                        â”‚ Read JSON â”€â”€â”€â”€> â”‚
â”‚                        â”‚                 â”‚
â”‚                        â”‚                 â”‚ Signal changed?
â”‚                        â”‚                 â”‚ YES
â”‚                        â”‚                 â”‚
â”‚                        â”‚                 â”‚ Close old SELL
â”‚                        â”‚                 â”‚ orders â”€â”€â”€â”€â”€â”€> â”‚
â”‚                        â”‚                 â”‚                â”‚
â”‚                        â”‚                 â”‚                â”‚ Close #123
â”‚                        â”‚                 â”‚                â”‚
â”‚                        â”‚                 â”‚ Open new BUY   â”‚
â”‚                        â”‚                 â”‚ orders â”€â”€â”€â”€â”€â”€> â”‚
â”‚                        â”‚                 â”‚                â”‚ Open #456
â”‚                        â”‚                 â”‚                â”‚
â”‚                        â”‚                 â”‚ Update flags   â”‚
â”‚                        â”‚                 â”‚ signal_old=+1  â”‚
â”‚                        â”‚                 â”‚                â”‚
â”‚ 3s   â”‚                 â”‚                 â”‚                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¤                 â”‚                 â”‚                â”‚
â”‚      â”‚ Calculate WT    â”‚                 â”‚                â”‚
â”‚      â”‚ Still BUY       â”‚                 â”‚                â”‚
â”‚      â”‚                 â”‚                 â”‚                â”‚
â”‚      â”‚ Write JSON â”€â”€â”€â”€>â”‚                 â”‚                â”‚
â”‚      â”‚ (no change)     â”‚                 â”‚                â”‚
â”‚                        â”‚                 â”‚                â”‚
â”‚ 4s   â”‚                 â”‚                 â”‚                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¤                 â”‚                 â”‚                â”‚
â”‚                        â”‚ Read JSON â”€â”€â”€â”€> â”‚                â”‚
â”‚                        â”‚                 â”‚                â”‚
â”‚                        â”‚                 â”‚ Signal changed?â”‚
â”‚                        â”‚                 â”‚ NO (still +1)  â”‚
â”‚                        â”‚                 â”‚                â”‚
â”‚                        â”‚                 â”‚ Skip processingâ”‚
â”‚                        â”‚                 â”‚                â”‚
...continues every second...
```

### 6.3. State Machine - EA Trading Logic

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   IDLE STATE     â”‚
                    â”‚                  â”‚
                    â”‚ â€¢ No positions   â”‚
                    â”‚ â€¢ Waiting signal â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    Signal changed (+1 or -1)
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  OPENING STATE   â”‚
                    â”‚                  â”‚
                    â”‚ â€¢ Close old      â”‚
              â”Œâ”€â”€â”€â”€â”€â”‚ â€¢ Open new       â”‚
              â”‚     â”‚ â€¢ Set flags      â”‚
              â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚              â”‚
              â”‚     Order opened successfully
              â”‚              â”‚
              â”‚              â–¼
              â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚     â”‚  HOLDING STATE   â”‚
              â”‚     â”‚                  â”‚
              â”‚     â”‚ â€¢ Monitor P&L    â”‚
              â”‚     â”‚ â€¢ Check SL/TP    â”‚
              â”‚     â”‚ â€¢ Update dash    â”‚
              â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚              â”‚
              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚                     â”‚
              â”‚    Signal changed        Stoploss/Takeprofit hit
              â”‚              â”‚                     â”‚
              â”‚              â–¼                     â–¼
              â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â””â”€â”€â”€â”€>â”‚  CLOSING STATE   â”‚  â”‚  CLOSING STATE   â”‚
                    â”‚                  â”‚  â”‚                  â”‚
                    â”‚ â€¢ Close by magic â”‚  â”‚ â€¢ Close by risk  â”‚
                    â”‚ â€¢ Reset flags    â”‚  â”‚ â€¢ Reset flags    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚                     â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                              Order closed successfully
                                        â”‚
                                        â–¼
                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚   IDLE STATE     â”‚
                             â”‚                  â”‚
                             â”‚ Wait next signal â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. CHI TIáº¾T Ká»¸ THUáº¬T

### 7.1. Performance Metrics

| Metric | SPY Bot | EA Bot |
|--------|---------|--------|
| **OnTimer Frequency** | 1 second | 1 second |
| **CPU Usage** | ~2-5% (7 TF calc) | ~1-2% (read file) |
| **File I/O** | Write every second | Read every second |
| **File Size** | ~2 KB (JSON) | N/A |
| **Latency** | <50ms (WT calc) | <10ms (JSON parse) |
| **Memory** | ~5 MB | ~3 MB |

### 7.2. File System Requirements

**Folder Structure:**
```
MT4/MT5 Terminal/
â””â”€â”€ MQL4/ or MQL5/
    â””â”€â”€ Files/
        â””â”€â”€ DataAutoOner/
            â”œâ”€â”€ XAUUSD.json      â† SPY writes, EA reads
            â”œâ”€â”€ EURUSD.json
            â””â”€â”€ ... (other symbols)
```

**Permissions:**
- Read/Write for both SPY and EA
- Shared folder access
- Atomic write operations

### 7.3. Multi-Symbol Support

**MT4 Version:**
- âŒ Single symbol only
- Reason: File I/O limitations, architecture constraints

**MT5 Version:**
- âœ… Multi-symbol capable
- Architecture: `g_ea_array[10]` for up to 10 symbols
- Input: `EnableMultiSymbol = true`, `Symbols = "XAUUSD,EURUSD,GBPUSD"`
- Each symbol has independent CSDL file

### 7.4. Scalability

**Current Limits:**

| Component | Limit | Reason |
|-----------|-------|--------|
| **Timeframes** | 7 (M1-D1) | Hardcoded arrays |
| **Strategies** | 3 + 1 BONUS | Magic number design |
| **Symbols (MT4)** | 1 | Single instance |
| **Symbols (MT5)** | 10 | Array size |
| **Max Orders** | 21 per symbol | 7 TF Ã— 3 strategies |

**Expandable:**
- Add more TF: Requires array expansion
- Add more strategies: Requires magic number redesign
- Add more symbols (MT5): Change `g_ea_array` size

### 7.5. Error Recovery

**SPY Bot Recovery:**
1. File write fails â†’ Retry 3 times â†’ Skip this cycle
2. WT calculation error â†’ Use last valid signal
3. Health check stuck â†’ Auto-reset all TF charts

**EA Bot Recovery:**
1. File read fails â†’ Retry 3 times â†’ Use old data
2. Invalid JSON â†’ Skip this cycle, wait next update
3. Order send fails â†’ Retry with error handling
4. Position close fails â†’ Retry with price refresh

### 7.6. Testing Recommendations

**SPY Bot Testing:**
```
1. Strategy Tester (MT4)
   - Indicator mode
   - Visual mode ON
   - Check CSDL file generation

2. Live Chart Testing
   - Open 7 TF charts (M1-D1)
   - Attach SPY to any chart
   - Monitor CSDL file updates
   - Check dashboard display

3. Stress Testing
   - High volatility periods
   - News events
   - Weekend gaps
```

**EA Bot Testing:**
```
1. Strategy Tester (MT4/MT5)
   - EA mode
   - Use historical data
   - Check order execution
   - Verify P&L calculations

2. Demo Account
   - Run 24-48 hours minimum
   - Monitor all 21 orders
   - Check risk management
   - Verify BONUS logic

3. Backtesting
   - 3-6 months data
   - Compare with MT4 results
   - Optimize parameters
```

---

## ğŸ“Œ PHá»¤ Lá»¤C

### A. Glossary - Thuáº­t ngá»¯

| Term | Tiáº¿ng Viá»‡t | Ã nghÄ©a |
|------|------------|---------|
| **WaveTrend (WT)** | SÃ³ng xu hÆ°á»›ng | Oscillator indicator, ná»n táº£ng tÃ­n hiá»‡u |
| **SPY Bot** | Bot giÃ¡n Ä‘iá»‡p | Indicator giÃ¡m sÃ¡t 7 TF, tÃ­nh tÃ­n hiá»‡u |
| **EA Bot** | Bot tÆ° váº¥n | Expert Advisor thá»±c thi lá»‡nh |
| **CSDL** | CÆ¡ sá»Ÿ dá»¯ liá»‡u | File JSON truyá»n dá»¯ liá»‡u SPYâ†’EA |
| **NEWS CASCADE** | Tin tá»©c phá»‘i há»£p | Äá»™ máº¡nh tÃ­n hiá»‡u dá»±a trÃªn alignment |
| **TF** | Timeframe | Khung thá»i gian (M1/M5/M15/M30/H1/H4/D1) |
| **Magic Number** | Sá»‘ magic | ID duy nháº¥t cho má»—i order |
| **S1/S2/S3** | Strategy 1/2/3 | CÃ¡c chiáº¿n lÆ°á»£c giao dá»‹ch |
| **BONUS** | ThÆ°á»Ÿng | Orders phá»¥ khi NEWS máº¡nh |

### B. Configuration Examples

**SPY Bot Settings (Recommended):**
```
Timer = 1                          // 1 second refresh
Retry = 3                          // 3 retry attempts
TargetSymbol = ""                  // Empty = current chart
EnableHealthCheck = true           // Auto-reset if stuck
EnableMidnightReset = true         // Daily reset
ProcessSignalOnOddSecond = true    // Avoid conflict with EA
NewsBaseLiveDiff = 2.5             // USD threshold
NewsLiveDiffStep = 0.5             // Increment per level
```

**EA Bot Settings (Conservative):**
```
S1_HOME = true                     // Enable binary strategy
S2_TREND = true                    // Enable trend following
S3_NEWS = true                     // Enable news alignment
EnableBonusNews = true             // Enable bonus orders
UseEvenOddMode = true              // Read on even seconds
StoplossMode = LAYER2              // 2-layer protection
MaxLossPerOrder = 50               // $50 per order
EmergencyDrawdownPercent = 20      // 20% account drawdown
BonusLotMultiplier = 1.5           // 1.5x lot for bonus
MinNewsLevelBonus = 13             // Level 3+ news
```

### C. Common Issues & Solutions

| Issue | Cause | Solution |
|-------|-------|----------|
| **SPY not writing file** | Folder permission | Check `DataAutoOner\` exists |
| **EA not reading file** | File lock conflict | Enable `UseEvenOddMode` |
| **Orders not opening** | Signal not changed | Check `HasValidS2BaseCondition()` |
| **Duplicate orders** | Timestamp not updating | Verify SPY is running |
| **BONUS not closing** | M1 not triggering | Check `tf == 0` condition |
| **High CPU usage** | Too many TF charts | Limit to 7 TF only |

---

## ğŸ¯ Káº¾T LUáº¬N

### Æ¯u Ä‘iá»ƒm cá»§a há»‡ thá»‘ng

1. âœ… **Modular Design**: SPY vÃ  EA tÃ¡ch biá»‡t, dá»… maintain
2. âœ… **WaveTrend Foundation**: Indicator proven, reliable signals
3. âœ… **Multi-Timeframe**: 7 TF coverage, tá»« M1 Ä‘áº¿n D1
4. âœ… **Multi-Strategy**: 4 strategies, Ä‘a dáº¡ng cÃ¡ch vÃ o lá»‡nh
5. âœ… **Risk Management**: 3-layer protection
6. âœ… **NEWS CASCADE**: Äá»™ máº¡nh tÃ­n hiá»‡u, filter cháº¥t lÆ°á»£ng
7. âœ… **Auto-Recovery**: Health check, auto-reset
8. âœ… **MT5 Ready**: Full conversion, multi-symbol support

### NhÆ°á»£c Ä‘iá»ƒm vÃ  giá»›i háº¡n

1. âš ï¸ **File I/O Dependency**: Lá»—i file = lá»—i há»‡ thá»‘ng
2. âš ï¸ **1-Second Latency**: KhÃ´ng phÃ¹ há»£p scalping cá»±c nhanh
3. âš ï¸ **Single Symbol (MT4)**: KhÃ´ng há»— trá»£ multi-symbol
4. âš ï¸ **Fixed 7 TF**: KhÃ´ng thá»ƒ thÃªm TF tÃ¹y chá»‰nh
5. âš ï¸ **Complexity**: Cáº§n hiá»ƒu rÃµ 2 bots má»›i troubleshoot tá»‘t

### HÆ°á»›ng phÃ¡t triá»ƒn

1. ğŸš€ **Multi-Symbol MT4**: Port multi-symbol architecture
2. ğŸš€ **Additional Strategies**: S4, S5 vá»›i logic má»›i
3. ğŸš€ **Cloud Integration**: Upload CSDL to cloud, remote monitoring
4. ğŸš€ **Machine Learning**: ML model phÃ¢n tÃ­ch NEWS CASCADE
5. ğŸš€ **Mobile App**: Dashboard app cho iOS/Android

---

**TÃ¡c giáº£:** Multi-Trading-Bot-Oner V2 Team
**LiÃªn há»‡:** See project repository
**Giáº¥y phÃ©p:** Private/Proprietary

**Cáº£m Æ¡n báº¡n Ä‘Ã£ Ä‘á»c tÃ i liá»‡u nÃ y!** ğŸ™

---

*Document Version: 1.0*
*Last Updated: 2025-11-01*
*Generated by: Claude Code Agent*
